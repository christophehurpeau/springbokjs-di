{"version":3,"sources":["../src/Di.js"],"names":[],"mappings":"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","file":"src/Di.js","sourcesContent":["var path = require('path');\n\nexport default class Di {\n    constructor() {\n        this._classes = {};\n        this._singletons = {};\n        this._all = {};\n        this._globals = { di: this };\n    }\n\n    addGlobal(key, value) {\n        this._globals[key] = value;\n    }\n\n    add(name, value) {\n        this._add(name, value);\n    }\n\n    addClass(className, class_) {\n        this._add(className, class_, true);\n    }\n\n    get(key) {\n        return this[key];\n    }\n\n    set(key, value) {\n        this._all[key] = this[key] = value;\n    }\n\n    addModule(name, module) {\n        var value = module;\n\n        if (module.dependencies && typeof module !== 'function') {\n            throw new Error(name + ': dependencies in the module is deprecated');\n        }\n\n        if (module.default || typeof module === 'function') {\n            value = typeof module === 'object' ? module.default : module;\n            if (module.dependencies) {\n                Object.defineProperty(value, 'dependencies', {\n                    configurable: true,\n                    writable: false,\n                    enumerable: false,\n                    value: module.dependencies\n                });\n            }\n            this._add(name, value);\n            var result = {};\n            result[name] = value;\n            return result;\n            // return { [name]: value };\n        } else {\n            Object.keys(module).map((key) => {\n                this._add(key, module[key]);\n            });\n            return module;\n        }\n    }\n\n    addAll(map) {\n        Object.keys(map).forEach((name) => {\n            var key = (function(splitted) { return splitted[splitted.length - 1]; })(name.split('/'))    ;\n            this.addModule(key, map[name]);\n        });\n    }\n\n    resolveDependencies(value, _internalCallCount = 0) {\n        return this._resolveDependencies(value, value.constructor.dependencies, _internalCallCount);\n    }\n\n    _resolveDependencies(value, dependencies, _internalCallCount) {\n        if (!dependencies) {\n            return;\n        }\n        if (_internalCallCount > 20) {\n            throw new Error('Called more than 20 times _resolveDependencies');\n        }\n\n        if (!dependencies.forEach) {\n            console.log(dependencies);\n            throw new Error('Invalid dependencies value');\n        }\n\n        dependencies.forEach((dependency) => {\n            // console.log('='.repeat(_internalCallCount) + '> ' + 'Resolving dependency ' + dependency.key);\n            Object.defineProperty(value, dependency.key, {\n                get: function() {\n                    var dependencyValue = this._all[dependency.name];\n                    if (!dependencyValue) {\n                        throw new Error(value.name + ': Failed to resolve dependency ' + dependency.name);\n                    }\n\n                    if (dependency.call || dependency.arguments) {\n                        var instance = this.createInstanceOf(dependencyValue, dependency.arguments, _internalCallCount);\n                        if (dependency.call) {\n                            Object.keys(dependency.call).forEach((methodName) => {\n                                if (!instance[methodName]) {\n                                    throw new Error('Cannot call ' + methodName + ' in class ' + dependency.key);\n                                }\n                                instance[methodName].apply(instance, dependency.call[methodName]);\n                            });\n                        }\n                        dependencyValue = instance;\n                    }\n\n                    Object.defineProperty(value, dependency.key, {\n                        value: dependencyValue,\n                        writable: false,\n                        configurable: false,\n                        enumerable: false\n                    });\n                    return dependencyValue;\n                }.bind(this),\n                configurable: true,\n                enumerable: false\n            });\n        });\n    }\n\n    _add(name, value, isClass) {\n        if (!value) {\n            throw new Error('Trying to add a empty value in the di: ' + name);\n        }\n        if (this._all[name]) {\n            console.warn('[warn] ' + name + ' is already defined');\n        }\n        this._all[name] = this[name] = value;\n        var basename = path.basename(name);\n        if (isClass || (typeof value === 'function' && basename[0].toUpperCase() === basename[0])) {\n            this._classes[name] = value;\n            if (!value.displayName) {\n                value.displayName = name;\n            }\n            if (value.singleton) {\n                var key = name[0].toLowerCase() + name.substr(1);\n                for (var thing of [this._singletons, this._all, this]) {\n                    Object.defineProperty(thing, key, {\n                        enumerable: true,\n                        configurable: true,\n                        get: () => {\n                            var instance = this.createInstanceOf(value);\n                            Object.defineProperty(thing, key, {\n                                enumerable: true,\n                                configurable: true,\n                                wriable: false,\n                                value: instance\n                            });\n                            return instance;\n                        }\n                    });\n                }\n            }\n        }\n        if (value.dependencies) {\n            Object.defineProperty(value, 'dependencies', {\n                configurable: true,\n                writable: false,\n                enumerable: false,\n                value: this.constructor.parseDependencies(value.dependencies)\n            });\n        }\n    }\n\n    static parseDependencies(dependencies) {\n        return (function() {\n            if (Array.isArray(dependencies)) {\n                return dependencies.map((v) => {\n                    return {\n                        key: v,\n                        name: v\n                    };\n                });\n            } else {\n                return Object.keys(dependencies).map((key) => {\n                    var dependency = dependencies[key];\n                    if (typeof dependency === 'string') {\n                        dependency = { name: dependency };\n                    }\n                    dependency.key = key;\n\n                    if (!dependency.name) {\n                        dependency.name = key;\n                        if (dependency.arguments || dependency.call) {\n                            dependency.key = key[0].toLowerCase() + key.substr(1);\n                        }\n                    }\n                    return dependency;\n                });\n            }\n        })().filter(Boolean);\n    }\n\n    createInstance(className, args, _internalCallCount = 0) {\n        // console.log('='.repeat(_internalCallCount) + '> ' + 'Creating instance of ' + className);\n        if (!className) {\n            throw new Error('Unexpected value for className');\n        }\n        var Class_ = this._classes[className];\n        if (!Class_) {\n            throw new Error('Class ' + className + ' not found');\n        }\n        return this.createInstanceOf(Class_, args, _internalCallCount);\n    }\n\n    createInstanceOf(Class_, args, _internalCallCount = 0) {\n        var instance = Object.create(Class_.prototype);\n        // console.log('='.repeat(_internalCallCount) + '> ' + className, Class_, args, instance);\n        Object.keys(this._globals).forEach((key) => {\n            Object.defineProperty(instance, key, {\n                enumerable: false,\n                writable: false,\n                configurable: true,\n                value: this._globals[key]\n            });\n        });\n        if (Class_.dependencies) {\n            this._resolveDependencies(instance, Class_.dependencies, _internalCallCount);\n        }\n        Class_.apply(instance, args);\n\n        Object.defineProperty(instance, 'logger', {\n            get: function() {\n                var logger = this._createLogger(Class_.name);\n                Object.defineProperty(instance, 'logger', {\n                    writable: false,\n                    configurable: false,\n                    value: logger\n                });\n                return logger;\n\n            }\n        });\n\n        return instance;\n    }\n}\n"]}